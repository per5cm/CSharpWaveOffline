@page "/pets"
@rendermode InteractiveServer
@using VPets.Data
@using VPets.Models
@using Microsoft.EntityFrameworkCore
@inject VPetsContext Db

@if (petBeingEdited == null)
{
    <h2>Willkommen zu VPets!</h2>
    <p>Erstellen und verwalten Sie Ihre virtuellen Haustiere.</p>

    <h3>Virtuelles Haustier anlegen</h3>

    <div>
        <label>Name:</label>
        <input @bind="newPet.Name" />
    </div>
    <div>
        <label>Tierart:</label>
        <input @bind="newPet.Species" />
    </div>
    <div>
        <label>Alter:</label>
        <input type="number" @bind="newPet.Age" />
    </div>

    <button type="button" @onclick="SavePet">Speichern</button>

    <h3>Liste der Haustiere (@pets.Count)</h3>
    <ul>
        @foreach (var pet in pets)
        {
            <li>
                @pet.Name (@pet.Species, @pet.Age Jahre alt)
                <button @onclick="() => EditPet(pet.Id)">✏️</button>
                <button @onclick="() => DeletePet(pet.Id)">🗑️</button>
            </li>
        }
    </ul>
}
@if (petBeingEdited != null)
{
    <h3>Haustier bearbeiten</h3>
    <div>
        <label>Name:</label>
        <input @bind="newPet.Name" />
    </div>
    <div>
        <label>Tierart:</label>
        <input @bind="newPet.Species" />
    </div>
    <div>
        <label>Alter:</label>
        <input type="number" @bind="newPet.Age" />
    </div>
    <button type="button" @onclick="UpdatePet">Aktualisieren</button>
    <button type="button" @onclick="CancelEdit">Abbrechen</button>
}


@code {
    Pet newPet = new();
    List<Pet> pets = new();
    Pet? petBeingEdited = null; // for edit mode

    protected override async Task OnInitializedAsync()
    {
        pets = await Db.Pets.ToListAsync();
    }

    async Task SavePet()
    {
        try
        {
            if (petBeingEdited == null)
            {
                Db.Pets.Add(newPet);
            }
            else
            {
                // Update existing pet
                petBeingEdited.Name = newPet.Name;
                petBeingEdited.Species = newPet.Species;
                petBeingEdited.Age = newPet.Age;
            }

            await Db.SaveChangesAsync();
            pets = await Db.Pets.ToListAsync();
            newPet = new Pet();
            petBeingEdited = null; // exit edit mode
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
        }
    }

    async Task EditPet(int id)
    {
        petBeingEdited = await Db.Pets.FirstOrDefaultAsync(p => p.Id == id);

        if (petBeingEdited == null) return;

        // Copy into the input fields so user can edit it
        newPet = new Pet
        {
            Id = petBeingEdited.Id,
            Name = petBeingEdited.Name,
            Species = petBeingEdited.Species,
            Age = petBeingEdited.Age
        };
    }

    async Task UpdatePet()
    {
        if (petBeingEdited == null) return;
        petBeingEdited.Name = newPet.Name;
        petBeingEdited.Species = newPet.Species;
        petBeingEdited.Age = newPet.Age;
        await Db.SaveChangesAsync();
        pets = await Db.Pets.ToListAsync();
        newPet = new Pet();
        petBeingEdited = null; // exit edit mode
    }

    void CancelEdit()
    {
        newPet = new Pet();
        petBeingEdited = null; // exit edit mode
    }

    async Task DeletePet(int id)
    {
        var petToDelete = await Db.Pets.FirstOrDefaultAsync(p => p.Id == id);

        if (petToDelete != null)
        {
            Db.Pets.Remove(petToDelete);
            await Db.SaveChangesAsync();

            pets = await Db.Pets.ToListAsync();
            StateHasChanged(); // force rerender
        }
    }
}

